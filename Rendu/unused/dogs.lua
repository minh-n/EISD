dark = require("dark")

-- Ensemble de données
local labrador = "Le labrador est un chien créé originaire de la Dalmatie (région de la Croatie) pour la chasse : c'est un chien de rapport notamment dans les marais réputé en raison de son très bon odorat, de sa « dent douce » et de ses aptitudes exceptionnelles de natation. Il est également utilisé comme chien de recherche au sang. Le labrador est très utilisé comme chien de travail, notamment comme chien d'assistance aux handicapés visuels et physiques, chien de sauvetage, chien de détection, chien policier, chien truffier. Avec le Golden retriever, le labrador est utilisé comme chien d'assistance aux personne à mobilité réduite, mais aussi comme chien d'éveil aux personnes autistes, trisomiques ou polyhandicapées. En France, ces deux races sont principalement sélectionnés par l'association Handi'chiens grâce à leur caractère calme, leur sociabilité, leur instinct de rapport d'objets et apportent un soutien moral et affectif aux personnes en situation de handicap ainsi qu'une grande autonomie. Le Labrador fait également partie des chiens de sauvetage à l'eau (avec le Terre-neuve, le Landseer, tous les retrievers, le Leonberg, le Berger polonais de Podhale, l'Hovawart, les bouviers suisses et tous les chiens d'eau du 8e groupe, le Terrier noir russe, et le Saint-Bernard). Capable de vivre aussi bien en ville qu'à la campagne, c'est un chien de compagnie qui a besoin d'exercice physique."
local beagle = "Chien de chasse d'origine britannique. Historiquement, la race a été développée en Angleterre pour la chasse à courre du lièvre : les beagles étaient vus comme les compagnons de chasse idéaux par les anciens qui pouvaient les suivre à cheval sans se fatiguer, par les jeunes qui les suivaient sur des poneys et pour les plus pauvres à pied. Avec la mode des chasses rapides, le beagle, trop petit, tombe en désuétude, mais est toujours employé pour la chasse au lapin. Chasser le lièvre avec une meute de beagles redevient populaire au milieu du xixe siècle. La chasse à courre du lièvre est à présent illégale en Écosse depuis le Protection of Wild Mammals (Scotland) Act 2002 et en Angleterre et au pays de Galles depuis le Hunting Act 2004. Chasser avec des beagles à pied est considéré comme idéal pour les jeunes personnes et de nombreuses écoles privées britanniques entretiennent par tradition une meute de beagles. Des meutes sont toujours entretenues par les écoles et les universités britanniques suivantes malgré les protestations des associations anti-chasse : Eton, Marlborough, Wye, Radley, le Royal Agricultural College et Christ Church. Cependant, une meute du Wye College dans le Kent a été volée par le front de libération des animaux en 2001. La meute traditionnelle à pied est constituée de plus de 70 beagles, menée par un maitre d'équipage assisté par un nombre variable de valets – dont le travail consiste à retrouver les chiens égarés. Ce sont des chiens faciles à ameuter : ils courent très proches les uns des autres ce qui est très utile pour une longue chasse, car cela évite de perdre des chiens et la piste du gibier. Les beagles peuvent aussi être employés seuls ou en couple. La chasse au leurre est populaire là où la chasse est interdite ou pour les propriétaires qui ne souhaitent pas participer à une mise à mort tout en souhaitant tout de même voir à l'œuvre les qualités de leurs chiens. En France, 95 % des propriétaires de beagle sont des chasseurs. Bien qu'étant incontournable pour les équipages de petite vénerie, la race est surtout utilisée pour la chasse à pied du gibier à poil tel que le lapin et du lièvre. Il est également le chien courant le plus utilisé pour la chasse au chevreuil. Il chasse le renard dans l'ouest de la France et le sanglier dans le Midi. Aux États-Unis ils sont employés principalement pour la chasse aux lapins depuis les premières importations. Le tableau de chasse des beagles inclut aussi le lièvre d’Amérique, le lapin d’Amérique, des oiseaux, le chevreuil, le cerf élaphe, le lynx roux, le coyote, le sanglier et le renard, et quelques cas de chasse à l’hermine sont recensés. Dans la plupart de ces cas, le beagle est utilisé comme rabatteur. Le beagle est mieux taillé pour la chasse au lièvre que le harrier, en raison de son odorat très fin et de son endurance. Dans les sous-bois épais, ils sont aussi préférés aux épagneuls pour la chasse au faisan. Chien de détection Les beagles sont utilisés comme chiens de détection dans la Beagle Brigade par le département de l’Agriculture des États-Unis. Ces chiens détectent la nourriture dans les bagages entrant aux USA. Après avoir essayé différentes races, les autorités ont choisi les beagles parce qu’ils sont petits et peu effrayants pour les gens cynophobes, faciles à entretenir, intelligents et bons travailleurs à condition d’obtenir une récompense. Ils font le même travail dans d’autres pays comme en Nouvelle-Zélande (Ministry of Agriculture and Forestry), en Australie (Australian Quarantine and Inspection Service), au Canada, au Japon et en république populaire de Chine. Des races plus grandes sont en général utilisées pour la détection des explosifs, qui nécessite de pouvoir grimper sur les bagages, ce qui n’est pas simple pour un beagle. Les beagles sont utilisés comme chiens de détection des termites en Australie et ont été signalés comme candidats possibles comme chien anti-drogue et anti-explosif. Chien de laboratoire Le beagle est la race de chien la plus utilisée pour des tests sur animaux, en raison de sa taille et de son naturel doux. Sur les 8 018 chiens utilisés au Royaume-Uni en 2004, 7 799 sont des beagles (97,3 %) ; en 2005, ce pourcentage diminue à 96,6 %. Aux États-Unis, où la race de chien utilisée n’est pas spécifiée, le nombre annuel de tests effectués sur les chiens a diminué de deux tiers, passant de 195 157 en 1973 à 64 932 en 2004. En France, la race est également non spécifiée, mais le nombre de chiens utilisés dans les laboratoires est stable depuis 2001, avec en moyenne 5 500 chiens ; pour un éleveur français, la vente de beagles à des laboratoires est un motif d'exclusion au club de la race. Au Japon, la loi n'exige pas que l’espèce et le nombre d’animaux soit révélés. Au Royaume-Uni, les beagles de laboratoire sont « produits » spécialement dans ce but par des sociétés comme Harlan, qui doivent obtenir une autorisation pour élever ses chiens destinés à la science. Toutefois, les groupes anti-vivisection ont rapporté des abus sur les animaux de laboratoire et exercé des pressions pour faire cesser ces activités qu’ils jugent barbares : par exemple, la société d’élevage Consort Kennels a fermé en 1997 sous la pression des associations pour le droit des animaux. En 1997, des images secrètement filmées par un journaliste indépendant dans le Huntingdon Life Sciences montrent le personnel frappant et criant sur les beagles de laboratoire. Les beagles sont utilisés dans de nombreuses disciplines : biologie fondamentale, médecine humaine appliquée, médecine vétérinaire, protection de l’environnement humain et animal. Le test des cosmétiques sur les animaux est interdit dans les pays membres de l’Union européenne. Il est permis aux États-Unis s’il n’est pas possible de recourir à d’autres méthodes, mais quand il faut tester la toxicité des additifs alimentaires, des médicaments et de certains produits chimiques, la FDA utilise des beagles et des cochons vietnamiens comme substituts au test sur les hommes. Chien de compagnie Le beagle est aussi un chien de compagnie très apprécié, bien qu'il soit davantage utilisé pour la chasse (seuls 4 à 5 % des beagles sont des chiens de compagnie). La race est mise en avant dans les médias sans être sur-médiatisée. Le physique sympathique et doux du beagle, ainsi que son gabarit réduit et son caractère amical, séduit les familles et les citadins. En France, le club de la race met en avant la polyvalence de la race, qui peut faire des activités telles que l'agility, du cani-cross ou encore du flyball. Ces utilisations restent cependant très ponctuelles, le beagle étant essentiellement un chien de chasse. En raison de leur tempérament amical et de leur gabarit, ils sont aussi fréquemment utilisés en thérapie animale, visitant les malades et les personnes âgées dans les hôpitaux."
local terre_neuve = "ce son pays d'origine, l'Allemagne, Le terre-neuve fait partie des chiens de sauvetage à l'eau (avec le Landseer, tous les retrievers, le Leonberg, le Berger polonais de Podhale, l'Hovawart, les bouviers suisses et tous les chiens d'eau du 8e groupe, le Terrier noir russe, et le Saint-Bernard)."

-- FUNCTIONS
function haveTag(seq, tag)
	return #seq[tag] ~= 0
end

function tagString(seq, tag, b_gin, e_nd)
	-- Valeurs par défaut
	b_gin, e_nd = b_gin or 1, e_nd or #seq
	
	if not haveTag(seq, tag) then
		return
	end
	
	for idx, pos in ipairs(seq[tag]) do
		local start, finish = pos[1], pos[2]
		if start >= b_gin and finish <= e_nd then
			local res = {}
	
			-- Concaténer les tokens avec des espaces entre
			for i = start, finish do 
				res[#res + 1] = seq[i].token
			end
			
			return table.concat(res, " ")
		end
	end
end

function tagStringInLink(seq, link, tag)
	if not haveTag(seq, link) then
		return
	end
	
	local pos = seq[link][1]
	local start, finish = pos[1], pos[2]
	
	return tagString(seq, tag, start, finish)
end

function createUseArray(seq)
	if not haveTag(seq, "#use") then
		return
	end
	
	use_array = {}
	exists = {}
	use_array[#use_array + 1] = "chien de compagnie"
	exists["chien de compagnie"] = 1
	
	for idx, pos in ipairs(seq["#use"]) do
		local start, finish = pos[1], pos[2]
		local res = {}
		for i = start, finish do 
			if seq[i].token == "chiens" then
				res[#res + 1] = "chien"
			else
				res[#res + 1] = seq[i].token
			end
		end
		dog_use = table.concat(res, " ")
		
		if not exists[dog_use] then
			use_array[#use_array + 1] = dog_use
			exists[dog_use] = true
		end
	end
	
	return use_array
end

-- TODO : detect section

-- Création d'une pipeline pour stocker les filtres
local main = dark.pipeline()

-- Pipeline d'utilité
local pre_proc = dark.pipeline()
local dog_use, dog_origin = dark.pipeline(), dark.pipeline()
dog_use:lexicon("#use", "dog_use.txt")
pre_proc:pattern([[ [#detle (la | le | l "'" | les)] ]])
pre_proc:pattern([[ [#detde de #detle | du | des | d "'"] ]])

dog_origin:pattern([[ 
	((originaire #detde) | (#detde origine) | #detde origine "," #detle) 
	[#origin #w{1,6} | #w{1,6} "-" #w] 
	(("," | ".") | "(" ) 
]])

-- Annotateurs classique (donne des tags aux tokens)
main:basic()
main:add(pre_proc)						
main:add(dog_use)
main:add(dog_origin)

-- PATTERNS
main:pattern([[	("Le" | "appelé" | "le") [#race (#w | #w #w | #w "-" #w)] (( "ou" | "est" | "fait") | /\(/ ) ]])

-- Création de séquences
labrador = labrador:gsub("%p", " %0 "):lower()
beagle = beagle:gsub("%p", " %0 "):lower()
terre_neuve = terre_neuve:gsub("%p", " %0 "):lower()

local seqs = {}
seqs[#seqs + 1] = dark.sequence(beagle)
seqs[#seqs + 1] = dark.sequence(labrador)
seqs[#seqs + 1] = dark.sequence(terre_neuve)

-- Application des patterns et lexiques grace à notre pipeline
for _, seq in pairs(seqs) do
	main(seq)
end

-- Tags et couleurs pour l'affichage de la séquence
local tags = {
			["#origin"] = "red",
			["#use"] = "cyan",
			--["#detde"] = "yellow",
			--["#detle"] = "magenta"
		}
		
-- Base de données
local db = {
	--["golden retriever"] = {
	--	height = "taille moyenne",
	--	weight = "",
	--	origin = "",
	--	use = {
	--		[1] = "",
	--		[2] = ""
	--	}
	--}
}		

for _, seq in pairs(seqs) do
	if haveTag(seq, "#race") then
		-- RACE 
		local race = tagStringInLink(seq, "#race", "#race")

		-- USE
		db[race] = db[race] or {}
		use_array = createUseArray(seq)
		if use_array ~= NIL then
			db[race].use = use_array
		end
		
		-- ORIGIN
		local origin = tagStringInLink(seq, "#origin", "#origin")
		if origin ~= NIL then
			db[race].origin = origin
		end
	end
	
	print("###\n")
	print(seq:tostring(tags))
	print("\n###")
end
		



print(serialize(db))
